{% extends "analyzer/base.html" %}

{% block content %}


    <h1 class="text-center mb-4">Анализ технологических стеков IT-проектов</h1>


    <div class="highlight-card mb-5">
        <h3 class="text-center mb-3 text-primary">Добавить технологии к проекту</h3>

        <form method="post">
            {% csrf_token %}


            <div class="project-row mb-3">
                <div class="project-col">
                    {{ form.existing_project.label_tag }}
                    {{ form.existing_project }}
                </div>
                <div class="divider"></div>
                <div class="project-col text-end">
                    {{ form.new_project.label_tag }}
                    {{ form.new_project }}
                </div>
            </div>

            <hr>

            <div class="row">
                {% for field in form %}
                    {% if field.name not in "existing_project new_project" %}
                        <div class="col-md-4 mb-3">
                            <div class="border rounded p-3 h-100">
                                <strong>{{ field.label }}</strong>
                                <div class="mt-2">{{ field }}</div>
                            </div>
                        </div>
                    {% endif %}
                {% endfor %}
            </div>

            {% if form.non_field_errors %}
                <div class="alert alert-danger mt-3">
                    {{ form.non_field_errors }}
                </div>
            {% endif %}

            <button type="submit" class="btn btn-primary mt-3">Сохранить</button>
        </form>
    </div>


    <form method="get" class="row mb-4">
        <div class="col-md-6">
            <label class="form-label">Фильтр по проекту</label>
            <select name="project" class="form-select" onchange="this.form.submit()">
                <option value="">Все проекты</option>
                {% for project in projects %}
                    <option value="{{ project.id }}"
                        {% if project.id|stringformat:"s" == request.GET.project %}selected{% endif %}>
                        {{ project.name }}
                    </option>
                {% endfor %}
            </select>
        </div>
    </form>


    <h2 class="text-center mb-3">Популярность технологий</h2>
    <table class="table table-striped table-bordered" id="tech-table">
        <thead class="table-dark">
            <tr>
                <th>Технология</th>
                <th>Количество проектов (локально)</th>
                <th>Популярность на GitHub</th>
            </tr>
        </thead>
        <tbody>
            {% for tech, count in tech_stats.items %}
            <tr>
                <td>{{ tech }}</td>
                <td>{{ count }}</td>
                <td class="github-count">Загрузка...</td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="3" class="text-center">Нет данных</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <p class="text-muted text-end">Данные взяты с API GitHub</p>


    <h2 class="text-center mt-5 mb-3">График популярности технологий</h2>
    <canvas id="techChart" height="120"></canvas>


    <h2 class="text-center mt-5 mb-3">Популярность технологий по категориям</h2>
    <canvas id="categoryChart" height="120"></canvas>

{% endblock %}

{% block extra_scripts %}
<script>
async function loadGithubStats() {
    const response = await fetch("{% url 'github_stats' %}");
    const data = await response.json();

    document.querySelectorAll("#tech-table tbody tr").forEach(row => {
        const tech = row.cells[0].innerText;
        row.cells[2].innerText = data[tech] ?? "Загрузка...";
    });


    const labels = [{% for tech in tech_stats.keys %}"{{ tech }}",{% endfor %}];
    const valuesLocal = [{% for tech, count in tech_stats.items %}{{ count }},{% endfor %}];
    const valuesGitHub = labels.map(tech => data[tech] ?? 0);

    const ctx = document.getElementById('techChart').getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                { label: 'Локально', data: valuesLocal },
                { label: 'GitHub', data: valuesGitHub }
            ]
        },
        options: {
            responsive: true,
            scales: { y: { beginAtZero: true } }
        }
    });


    const categoryLabels = [{% for cat in category_stats.keys %}"{{ cat }}",{% endfor %}];
    const categoryValues = [{% for cat, count in category_stats.items %}{{ count }},{% endfor %}];

    const ctxCategory = document.getElementById('categoryChart').getContext('2d');
    new Chart(ctxCategory, {
        type: 'bar',
        data: {
            labels: categoryLabels,
            datasets: [
                { label: 'Количество технологий', data: categoryValues }
            ]
        },
        options: {
            responsive: true,
            scales: { y: { beginAtZero: true } }
        }
    });
}

document.addEventListener("DOMContentLoaded", loadGithubStats);
</script>
{% endblock %}