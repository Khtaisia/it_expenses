{% extends "analyzer/base.html" %}

{% block content %}

    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <h1 class="text-center mb-4">–ê–Ω–∞–ª–∏–∑ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö —Å—Ç–µ–∫–æ–≤ IT-–ø—Ä–æ–µ–∫—Ç–æ–≤</h1>

    <!-- üîπ –ë–ª–æ–∫ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π -->
    <div class="highlight-card mb-5">
        <h3 class="text-center mb-3 text-primary">–î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –∫ –ø—Ä–æ–µ–∫—Ç—É</h3>

        <form method="post">
            {% csrf_token %}

            <!-- –í—ã–±–æ—Ä –ø—Ä–æ–µ–∫—Ç–∞ -->
            <div class="project-row mb-3">
                <div class="project-col">
                    {{ form.existing_project.label_tag }}
                    {{ form.existing_project }}
                </div>
                <div class="divider"></div>
                <div class="project-col text-end">
                    {{ form.new_project.label_tag }}
                    {{ form.new_project }}
                </div>
            </div>

            <hr>

            <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π -->
            <div class="row">
                {% for field in form %}
                    {% if field.name not in "existing_project new_project" %}
                        <div class="col-md-4 mb-3">
                            <div class="border rounded p-3 h-100">
                                <strong>{{ field.label }}</strong>
                                <div class="mt-2">{{ field }}</div>
                            </div>
                        </div>
                    {% endif %}
                {% endfor %}
            </div>

            {% if form.non_field_errors %}
                <div class="alert alert-danger mt-3">
                    {{ form.non_field_errors }}
                </div>
            {% endif %}

            <button type="submit" class="btn btn-primary mt-3">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </form>
    </div>

    <!-- üîπ –§–ò–õ–¨–¢–†–ê–¶–ò–Ø –ü–û –ü–†–û–ï–ö–¢–£ -->
    <form method="get" class="row mb-4">
        <div class="col-md-6">
            <label class="form-label">–§–∏–ª—å—Ç—Ä –ø–æ –ø—Ä–æ–µ–∫—Ç—É</label>
            <select name="project" class="form-select" onchange="this.form.submit()">
                <option value="">–í—Å–µ –ø—Ä–æ–µ–∫—Ç—ã</option>
                {% for project in projects %}
                    <option value="{{ project.id }}"
                        {% if project.id|stringformat:"s" == request.GET.project %}selected{% endif %}>
                        {{ project.name }}
                    </option>
                {% endfor %}
            </select>
        </div>
    </form>

    <!-- üîπ –¢–∞–±–ª–∏—Ü–∞ -->
    <h2 class="text-center mb-3">–ü–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç—å —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π</h2>
    <table class="table table-striped table-bordered" id="tech-table">
        <thead class="table-dark">
            <tr>
                <th>–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è</th>
                <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–µ–∫—Ç–æ–≤ (–ª–æ–∫–∞–ª—å–Ω–æ)</th>
                <th>–ü–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç—å –Ω–∞ GitHub</th>
            </tr>
        </thead>
        <tbody>
            {% for tech, count in tech_stats.items %}
            <tr>
                <td>{{ tech }}</td>
                <td>{{ count }}</td>
                <td class="github-count">–ó–∞–≥—Ä—É–∑–∫–∞...</td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="3" class="text-center">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <p class="text-muted text-end">–î–∞–Ω–Ω—ã–µ –≤–∑—è—Ç—ã —Å API GitHub</p>

    <!-- üîπ –ì—Ä–∞—Ñ–∏–∫ -->
    <h2 class="text-center mt-5 mb-3">–ì—Ä–∞—Ñ–∏–∫ –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç–∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π</h2>
    <canvas id="techChart" height="120"></canvas>

{% endblock %}

{% block extra_scripts %}
<script>
async function loadGithubStats() {
    const response = await fetch("{% url 'github_stats' %}");
    const data = await response.json();

    document.querySelectorAll("#tech-table tbody tr").forEach(row => {
        const tech = row.cells[0].innerText;
        row.cells[2].innerText = data[tech] ?? "–ó–∞–≥—Ä—É–∑–∫–∞...";
    });

    const labels = [{% for tech in tech_stats.keys %}"{{ tech }}",{% endfor %}];
    const valuesLocal = [{% for tech, count in tech_stats.items %}{{ count }},{% endfor %}];
    const valuesGitHub = labels.map(tech => data[tech] ?? 0);

    const ctx = document.getElementById('techChart').getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                { label: '–õ–æ–∫–∞–ª—å–Ω–æ', data: valuesLocal },
                { label: 'GitHub', data: valuesGitHub }
            ]
        },
        options: {
            responsive: true,
            scales: { y: { beginAtZero: true } }
        }
    });
}

document.addEventListener("DOMContentLoaded", loadGithubStats);
</script>
{% endblock %}